# Impl√©mentation des Tensions comme Forces Physiques R√©elles

**Date** : 3 octobre 2025  
**Branche** : `feature/tension-forces-physics`  
**Objectif** : Ajouter forces de tension pour les **brides** (stabilisation interne) tout en gardant les lignes principales comme contraintes PBD (retenue √† distance fixe)

---

## üìã Contexte

### √âtat Actuel (AS-IS)

Dans la version actuelle, les tensions sont **calcul√©es mais pas appliqu√©es** :

```typescript
// PhysicsEngine.ts (ligne ~115)
// CALCUL DES TENSIONS (pour affichage/debug uniquement)
// Les lignes ne TIRENT PAS le kite - elles le RETIENNENT √† distance max
this.lineSystem.calculateLineTensions(kite, newRotation, pilotPosition);

// CALCUL DES TENSIONS DES BRIDES (pour affichage/debug uniquement)
const bridleTensions = this.bridleSystem.calculateBridleTensions(kite);
```

**Mod√®le actuel :**
- Forces = A√©rodynamique + Gravit√©
- Lignes/Brides = Contraintes PBD (distance maximale)
- Tensions = Affichage uniquement

**Probl√®mes identifi√©s :**
1. ‚ùå Les brides n'exercent pas de forces de stabilisation interne
2. ‚ùå L'√©quilibre du kite ne d√©pend pas des brides (uniquement contraintes g√©om√©triques)
3. ‚ùå L'orientation du kite n'est pas stabilis√©e par les tensions diff√©rentielles des brides
4. ‚ö†Ô∏è  Les lignes principales **retiennent** correctement √† distance fixe (PBD OK)
5. ‚ùå Les brides ne stabilisent pas l'angle d'attaque dynamiquement

---

## üéØ Objectif (TO-BE)

### Architecture Cible

**Nouveau mod√®le physique hybride : Lignes PBD + Forces Brides**

```
PhysicsEngine.update():
  1. Calculer vent apparent
  2. Calculer forces a√©rodynamiques
  3. NOUVEAU: Calculer forces de tension des BRIDES (structure interne)
  4. Appliquer toutes les forces (a√©ro + gravit√© + brides)
  5. Int√©grer position/v√©locit√© (F=ma, T=IŒ±)
  6. Appliquer contraintes PBD lignes principales (distance fixe)
  7. Appliquer contraintes PBD brides (distance max - s√©curit√©)
```

**Principe cl√© :** 
- **Lignes principales** = Contraintes PBD pures (retenue √† distance fixe, pas de forces)
- **Brides** = Forces de tension + contraintes PBD (stabilisation + s√©curit√©)
- Les brides agissent comme ressorts internes qui stabilisent l'angle d'attaque

---

## üî¨ Physique des Tensions

### 1. Lignes Principales (Pilote ‚Üí Kite) - INCHANG√â

**Les lignes principales restent des contraintes PBD pures** (comportement actuel correct) :

```typescript
// Contrainte g√©om√©trique uniquement - PAS de forces
ConstraintSolver.enforceLineConstraints(kite, newPosition, state, handles);

// R√©sultat : distance(CTRL_GAUCHE, HANDLE_LEFT) = lineLength (fixe)
//           distance(CTRL_DROIT, HANDLE_RIGHT) = lineLength (fixe)
```

**Pourquoi ne pas ajouter de forces sur les lignes principales ?**
- Les lignes Dyneema sont **quasi-inextensibles** (√©lasticit√© n√©gligeable)
- Elles se comportent comme des **tiges rigides** en tension
- Le mod√®le PBD actuel est **physiquement correct** pour ce cas
- Ajouter des forces cr√©erait une **redondance** et des **instabilit√©s**

**Tension calcul√©e** (pour affichage uniquement) :
```typescript
// La tension est r√©elle, mais elle n'applique pas de force
// C'est la r√©action aux contraintes g√©om√©triques
const tension = LinePhysics.calculateTension(line, distance, velocity);
```

### 2. Forces de Bride (Structure Interne)

Chaque bride (6 au total) exerce une force interne qui stabilise la g√©om√©trie :

```typescript
// Bride : NEZ ‚Üí CTRL_GAUCHE
const bridleVector = ctrlGauche.sub(nez);
const distance = bridleVector.length();
const direction = bridleVector.normalize();

const tension = LinePhysics.calculateTension(bridle, distance, velocity);
const bridleForce_atNez = direction.multiplyScalar(tension);      // Tire le NEZ vers CTRL
const bridleForce_atCtrl = direction.multiplyScalar(-tension);    // Tire le CTRL vers NEZ
```

**Effet sur l'√©quilibre :**
- Si NEZ trop loin ‚Üí bride tire le NEZ vers l'arri√®re
- Si CTRL trop loin ‚Üí bride tire le CTRL vers l'avant
- Stabilisation naturelle de l'angle d'attaque

### 3. √âquilibre Statique (Hovering)

Au point d'√©quilibre (kite immobile dans le vent) :

```
Œ£F = 0  ‚Üí  F_aero + F_gravity + F_bridles = 0
Œ£T = 0  ‚Üí  T_aero + T_bridles = 0

(Les lignes principales n'apparaissent pas car contraintes, pas forces)
```

**Exemple typique :**
- Portance (lift) = 50 N vers le haut
- Gravit√© = 5 N vers le bas
- Tra√Æn√©e (drag) = 30 N vers l'arri√®re
- **Lignes principales** : Contraintes g√©om√©triques (distance fixe maintenue par PBD)
- **Forces brides** : ~10-20 N internes qui stabilisent l'angle d'attaque
  - Brides NEZ ‚Üí tirent le nez vers l'arri√®re si angle trop grand
  - Brides CENTRE ‚Üí tirent le centre vers l'avant si angle trop petit
  - √âquilibre dynamique qui stabilise naturellement

---

## üèóÔ∏è Plan d'Impl√©mentation

### Phase 1 : Architecture des Forces de Tension

**Fichier** : `src/simulation/physics/TensionForceCalculator.ts`

```typescript
export interface TensionForceResult {
  // Forces lin√©aires
  force: THREE.Vector3;           // Force totale en N
  applicationPoint: string;        // Point d'application (nom anatomique)
  
  // Couple (torque)
  torque: THREE.Vector3;          // Moment en N‚ãÖm
  
  // Debug
  tension: number;                 // Tension en N
  direction: THREE.Vector3;        // Direction normalis√©e
}

export class TensionForceCalculator {
  /**
   * Calcule la force exerc√©e par une ligne sur le kite
   */
  static calculateLineForce(
    line: Line,
    kitePoint: THREE.Vector3,
    handlePoint: THREE.Vector3,
    kiteVelocity: THREE.Vector3,
    kiteCenter: THREE.Vector3
  ): TensionForceResult {
    // 1. Vecteur ligne
    const lineVector = new THREE.Vector3().subVectors(kitePoint, handlePoint);
    const distance = lineVector.length();
    const direction = lineVector.clone().normalize();
    
    // 2. V√©locit√© relative du point d'attache
    const leverArm = new THREE.Vector3().subVectors(kitePoint, kiteCenter);
    const pointVelocity = kiteVelocity.clone(); // Simplifi√© (TODO: ajouter œâ √ó r)
    
    // 3. Calculer tension via LinePhysics
    const tension = LinePhysics.calculateTension(line, distance, pointVelocity);
    
    // 4. Force = tension √ó direction (vers le pilote)
    const force = direction.multiplyScalar(-tension);
    
    // 5. Couple = r √ó F
    const torque = new THREE.Vector3().crossVectors(leverArm, force);
    
    return { force, torque, applicationPoint: line.kitePoint, tension, direction };
  }
  
  /**
   * Calcule les forces exerc√©es par une bride interne
   */
  static calculateBridleForces(
    bridle: Line,
    startPoint: THREE.Vector3,
    endPoint: THREE.Vector3,
    kiteVelocity: THREE.Vector3
  ): { startForce: TensionForceResult, endForce: TensionForceResult } {
    // Bride tire dans les deux sens (action-r√©action)
    const bridleVector = new THREE.Vector3().subVectors(endPoint, startPoint);
    const distance = bridleVector.length();
    const direction = bridleVector.clone().normalize();
    
    // V√©locit√© relative (simplifi√©)
    const relativeVelocity = new THREE.Vector3(); // TODO: tenir compte rotation
    
    const tension = LinePhysics.calculateTension(bridle, distance, relativeVelocity);
    
    // Force au point de d√©part (tire vers end)
    const forceStart = direction.clone().multiplyScalar(tension);
    
    // Force au point d'arriv√©e (tire vers start)
    const forceEnd = direction.clone().multiplyScalar(-tension);
    
    return {
      startForce: {
        force: forceStart,
        torque: new THREE.Vector3(), // TODO: calculer
        applicationPoint: bridle.attachments.kitePoint,
        tension,
        direction
      },
      endForce: {
        force: forceEnd,
        torque: new THREE.Vector3(), // TODO: calculer
        applicationPoint: bridle.attachments.barPoint,
        tension,
        direction: direction.clone().negate()
      }
    };
  }
}
```

### Phase 2 : Int√©gration dans PhysicsEngine

**Fichier** : `src/simulation/physics/PhysicsEngine.ts`

```typescript
update(deltaTime: number, targetBarRotation: number, isPaused: boolean = false): void {
  // ... code existant ...
  
  // √âTAPE 1 : Forces a√©rodynamiques (existant)
  const { lift, drag, torque: aeroTorque } = AerodynamicsCalculator.calculateForces(
    apparentWind,
    kite.quaternion
  );
  
  // √âTAPE 2 : Forces de gravit√© (existant)
  const gravity = new THREE.Vector3(0, -CONFIG.kite.mass * CONFIG.physics.gravity, 0);
  
  // √âTAPE 3 : NOUVEAU - Forces des brides (structure interne)
  const bridleForces = this.calculateBridleForces(kite);
  const bridleForcesTotal = bridleForces.totalForce;
  const bridleTorqueTotal = bridleForces.totalTorque;
  
  // √âTAPE 4 : Somme de TOUTES les forces
  const totalForce = new THREE.Vector3()
    .add(lift)
    .add(drag)
    .add(gravity)
    .add(bridleForcesTotal);   // NOUVEAU - brides uniquement
  
  // √âTAPE 5 : Somme de TOUS les couples
  const totalTorque = new THREE.Vector3()
    .add(aeroTorque)
    .add(bridleTorqueTotal);   // NOUVEAU - brides uniquement
  
  // √âTAPE 7 : Int√©gration + Contraintes PBD (existant)
  this.kiteController.update(totalForce, totalTorque, handles, deltaTime);
  
  // Les contraintes PBD restent comme filet de s√©curit√©
}

private calculateBridleForces(kite: Kite) {
  // Calculer forces pour les 6 brides
  // Retourner somme totale
  // TODO: impl√©menter
}
```

### Phase 3 : Adaptation du ConstraintSolver

**Pour les lignes principales :** AUCUN CHANGEMENT (comportement actuel correct)

```typescript
// ConstraintSolver.ts - enforceLineConstraints() INCHANG√â
// Les lignes restent des contraintes strictes (distance = lineLength)

static enforceLineConstraints(/* ... */) {
  // Comportement actuel : OK
  // Maintient distance exacte entre CTRL et HANDLE
  // C'est physiquement correct pour Dyneema quasi-inextensible
}
```

**Pour les brides :** Ajouter filet de s√©curit√©

```typescript
static enforceBridleConstraints(/* ... */) {
  // AVANT : Contrainte stricte (distance = bridleLength exactement)
  // APR√àS : Contrainte de distance MAXIMALE uniquement (s√©curit√©)
  
  if (distance > maxBridleLength * 1.02) {  // 2% de marge
    // Appliquer correction PBD (s√©curit√©)
  }
  
  // Sinon : laisser les forces de brides g√©rer la distance
}
```

### Phase 4 : Param√©trage et Tuning

**Fichier** : `src/simulation/config/SimulationConfig.ts`

```typescript
export const CONFIG = {
  // ... existant ...
  
  tensionForces: {
    enabled: true,                    // Toggle pour A/B testing
    
    // Poids des forces de tension (0-1)
    lineForceWeight: 1.0,             // 100% = forces pleines
    bridleForceWeight: 1.0,           // 100% = stabilisation compl√®te
    
    // Lissage temporel
    forceSmoothingFactor: 0.85,       // Lerp pour √©viter oscillations
    
    // Seuil de tension minimale
    minTensionThreshold: 5.0,         // N - en dessous = ignorer
    
    // Contraintes PBD comme s√©curit√©
    pbd: {
      maxLineExtension: 1.05,         // 5% d'extension max
      maxBridleExtension: 1.02,       // 2% d'extension max (plus rigide)
      iterations: 3,                   // Iterations PBD
    }
  }
};
```

---

## üß™ Tests et Validation

### Sc√©narios de Test

#### Test 1 : Hovering Stable
**Setup :**
- Vent constant 8 m/s
- Kite au z√©nith (90¬∞)
- Lignes √©gales

**R√©sultat attendu :**
- ‚úÖ Kite reste stable (oscillations < 10 cm)
- ‚úÖ Angle d'attaque stable (~15-20¬∞)
- ‚úÖ Tensions lignes √©quilibr√©es (~40N chacune)

#### Test 2 : Turn √† Gauche
**Setup :**
- Tirer ligne gauche (rotation barre -30¬∞)
- Vent 8 m/s

**R√©sultat attendu :**
- ‚úÖ Tension gauche augmente (~60N)
- ‚úÖ Tension droite diminue (~20N)
- ‚úÖ Couple net ‚Üí rotation horaire
- ‚úÖ Kite tourne √† gauche

#### Test 3 : Stabilisation par Brides
**Setup :**
- Perturber l'angle d'attaque (+10¬∞)
- Observer retour √† l'√©quilibre

**R√©sultat attendu :**
- ‚úÖ Brides NEZ tir√©es ‚Üí ram√®nent le nez
- ‚úÖ Retour √† angle stable en < 2s
- ‚úÖ Pas d'oscillations excessives

#### Test 4 : S√©curit√© PBD
**Setup :**
- Force externe extr√™me (rafale 20 m/s)
- V√©rifier que les lignes ne cassent pas

**R√©sultat attendu :**
- ‚úÖ Contraintes PBD emp√™chent extension > 5%
- ‚úÖ Tensions calcul√©es > maxTension
- ‚úÖ Kite ralenti par contraintes

---

## üìä M√©triques de R√©ussite

### Physique
- [ ] √âquilibre stable au z√©nith (oscillations < 10 cm)
- [ ] R√©ponse coh√©rente aux commandes (turn < 3s)
- [ ] Stabilisation angle d'attaque par brides (< 2s)
- [ ] Conservation √©nergie (pas de gain/perte irr√©aliste)

### Performance
- [ ] Framerate stable 60 FPS
- [ ] Calculs de tension < 2 ms total
- [ ] Pas d'instabilit√©s num√©riques

### UX
- [ ] Visualisation tensions en temps r√©el (HUD)
- [ ] Feedback visuel sur lignes (couleur tension)
- [ ] Toggle forces/contraintes pour A/B testing

---

## üöß Risques et Mitigations

### Risque 1 : Instabilit√© Num√©rique
**Sympt√¥me :** Oscillations explosives, kite "vibre"
**Cause :** Forces de tension trop raides + deltaTime trop grand
**Mitigation :**
- Lissage temporel des forces (lerp 0.85)
- Limiter deltaTime max (0.016s)
- Damping augment√© sur lignes/brides

### Risque 2 : Double Comptage des Forces
**Sympt√¥me :** Kite trop stable/rigide
**Cause :** Forces de tension + contraintes PBD = redondance
**Mitigation :**
- Contraintes PBD = s√©curit√© uniquement (> 105%)
- Forces de tension = comportement normal (< 105%)

### Risque 3 : Comportement Irr√©aliste
**Sympt√¥me :** Kite ne r√©agit plus comme avant
**Cause :** Param√®tres de tension incorrects
**Mitigation :**
- Toggle pour comparer ancien/nouveau mod√®le
- Tuning progressif des poids (0.0 ‚Üí 1.0)
- Tests A/B avec utilisateurs

---

## üìÖ Planning

### Sprint 1 : Foundation (3-5 jours)
- [ ] Cr√©er `TensionForceCalculator.ts`
- [ ] Impl√©menter `calculateLineForce()`
- [ ] Impl√©menter `calculateBridleForces()`
- [ ] Tests unitaires sur calculs de forces

### Sprint 2 : Int√©gration (3-5 jours)
- [ ] Modifier `PhysicsEngine.update()`
- [ ] Ajouter forces lignes au total
- [ ] Ajouter forces brides au total
- [ ] Adapter `ConstraintSolver` (s√©curit√© seulement)

### Sprint 3 : Tuning (5-7 jours)
- [ ] Tests hovering stable
- [ ] Tests turns gauche/droite
- [ ] Tests stabilisation brides
- [ ] Ajuster param√®tres (weights, smoothing, thresholds)

### Sprint 4 : Validation (2-3 jours)
- [ ] Tests de r√©gression
- [ ] Documentation utilisateur
- [ ] Merge vers main

**Dur√©e totale estim√©e :** 13-20 jours

---

## üìö R√©f√©rences

### Documents Existants
- `docs/LINE_PHYSICS_AUDIT_2025-10-01.md` ‚Äî Audit des tensions actuelles
- `docs/BRIDLES_AS_LINES_DESIGN.md` ‚Äî Architecture des brides
- `docs/OOP_LINE_ARCHITECTURE.md` ‚Äî Architecture lignes

### Litt√©rature Physique
- Position-Based Dynamics (M√ºller et al. 2007)
- Kite Physics (Loyd 2012)
- Tension-based Control Systems

### Code Critique
- `src/simulation/physics/LinePhysics.ts` ‚Äî Calcul tension Hooke
- `src/simulation/physics/ConstraintSolver.ts` ‚Äî PBD actuel
- `src/simulation/controllers/KiteController.ts` ‚Äî Int√©gration forces

---

**Auteur:** Matthieu (avec assistance AI)  
**Statut:** üîµ Design Document - Pr√™t pour impl√©mentation  
**Prochaine √©tape:** Cr√©er `TensionForceCalculator.ts` et commencer Sprint 1
